{% extends "base.html" %}
{% block content %}
<div class="container py-4">
    <div class="row mb-4 align-items-center">
        <div class="col-lg-8 col-md-6">
            <h3 class="fw-bold mb-0">
                <i class="fa fa-cloud me-2 text-primary"></i>
                Danh sách Cloudflare Account
            </h3>
        </div>
        <div class="col-lg-4 col-md-6 text-md-end text-start mt-3 mt-md-0">
            <a href="{{ url_for('cloudflare.add_account') }}" class="btn btn-primary me-2 mb-2">
                <i class="fa fa-plus"></i> Thêm Account
            </a>
        </div>
    </div>
    <div class="table-responsive rounded shadow-sm bg-white px-1">
        <table class="table table-hover align-middle mb-0" style="line-height: 1.3;">
            <thead class="table-light">
                <tr>
                    <th style="width:40px;">#</th>
                    <th>Tên</th>
                    <th>Email</th>
                    <th>Account ID</th>
                    <th>Nameservers</th>
                    <th class="text-center" style="width:180px;">Chức năng</th>
                </tr>
            </thead>
            <tbody>
                {% for acc in accounts %}
                <tr>
                    <td class="text-muted small">{{ loop.index }}</td>
                    <td>{{ acc.name }}</td>
                    <td>{{ acc.email }}</td>
                    <td style="font-family:monospace;">{{ acc.account_id }}</td>
                    <td style="font-size:0.95em;">
                        <div>{{ acc.ns1 or '-' }}</div>
                        <div>{{ acc.ns2 or '-' }}</div>
                    </td>
                    <td class="text-center align-middle">
                        <div class="d-flex justify-content-center gap-2 flex-wrap">
                            <!-- Nút đồng bộ domain -->
                            <form method="POST"
                                action="{{ url_for('cloudflare.sync_domains', account_id=acc.id) }}"
                                class="d-inline sync-form" style="display:inline;">
                                {{ form.csrf_token }}
                                <button type="submit"
                                        class="btn btn-sm btn-outline-info sync-btn"
                                        data-bs-toggle="tooltip"
                                        data-bs-placement="top"
                                        title="Đồng bộ toàn bộ domain & DNS từ Cloudflare">
                                    <i class="fa fa-sync-alt"></i>
                                    <span class="d-none d-lg-inline ms-1">Đồng bộ</span>
                                </button>
                            </form>
                            <!-- Nút xóa -->
                            <form method="POST"
                                action="{{ url_for('cloudflare.delete_account', account_id=acc.id) }}"
                                style="display:inline;" class="d-inline"
                                onsubmit="return confirm('Bạn chắc chắn muốn xóa tài khoản Cloudflare này?');">
                                {{ form.csrf_token }}
                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                    <i class="fa fa-trash"></i>
                                    <span class="d-none d-lg-inline ms-1">Xóa</span>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% if accounts|length == 0 %}
                <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                        <i class="fa fa-exclamation-circle me-1"></i>
                        Chưa có tài khoản Cloudflare nào.
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
<style>
    .table-responsive {
        background: #fff;
        border-radius: 12px;
        padding: 0.7rem;
    }
    .table td, .table th {
        vertical-align: middle !important;
        line-height: 1.3 !important;
    }
    .sync-btn {
        transition: background .12s, color .12s;
        position: relative;
    }
    .sync-btn[disabled] {
        opacity: 0.6;
        cursor: wait;
    }
    .sync-btn .fa-sync-alt.spin {
        animation: fa-spin 1s infinite linear;
    }
    @keyframes fa-spin {
        0% { transform: rotate(0deg);}
        100% { transform: rotate(359deg);}
    }
    @media (max-width: 576px) {
        .table th, .table td { font-size: 0.98em; }
        .d-flex.gap-1>* { margin-bottom: 3px; }
    }
</style>
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Tooltip Bootstrap cho các nút
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function(tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Hiệu ứng loading khi ấn Sync
    document.querySelectorAll(".sync-form").forEach(form => {
        form.addEventListener("submit", function(e) {
            const btn = form.querySelector(".sync-btn");
            if (btn) {
                btn.disabled = true;
                const icon = btn.querySelector(".fa-sync-alt");
                icon.classList.add("spin");
                btn.title = "Đang đồng bộ...";
            }
        });
    });
});
</script>
{% endblock %}
