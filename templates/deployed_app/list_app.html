{% extends "base.html" %}
{% block title %}Danh sách App Đã Deploy{% endblock %}

{% block content %}
<div class="container py-4">
	<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
		<h2 class="fw-bold mb-0">
			<i class="fa fa-th-list text-primary me-2"></i>
			Danh sách App Đã Deploy
		</h2>
		<div class="d-flex gap-2">
			<a href="{{ url_for('deployed_app.deploy_app') }}" class="btn btn-success">
				<i class="fa fa-plus"></i> Deploy App mới
			</a>
			<a href="{{ url_for('deployed_app.sync') }}" class="btn btn-info">
				<i class="fa fa-sync-alt"></i> Đồng bộ port và status
			</a>
		</div>
	</div>

	<!-- Search and Filter -->
	<div class="d-flex flex-wrap gap-3 align-items-center mb-3">
		<input id="searchInput" class="form-control" style="max-width:240px;" type="text"
			placeholder="Tìm kiếm server, domain, trạng thái..." autocomplete="off">
		<select id="statusFilter" class="form-select" style="max-width:160px;">
			<option value="">Tất cả trạng thái</option>
			<option value="active">Đang chạy</option>
			<option value="add_txt">Đã xác minh</option>
			<option value="deploying">Đang deploy</option>
			<option value="pending">Đang chờ</option>
			<option value="inactive">Đã dừng</option>
			<option value="failed">Lỗi deploy</option>
			<option value="removing">Đang xóa</option>
		</select>
	</div>

	<div class="table-responsive rounded shadow-sm bg-white">
		<table class="table table-hover align-middle mb-0">
			<thead class="table-light">
				<tr>
					<th style="width:40px;">#</th>
					<th>Server</th>
					<th>Domain đã deploy</th>
					{% if current_user.is_authenticated and current_user.is_admin %}
					<th>ENV</th>
					{% endif %}
					<th>Status</th>
					<th>Ngày tạo</th>
					<th>Thao tác</th>
				</tr>
			</thead>
			<tbody>
				{% for app, server, domain in deployed_apps %}
				<tr>
					<td class="text-muted small">{{ loop.index }}</td>
					<td>{{ server.name }}</td>
					<td>
						{% set full_domain = app.subdomain ~ '.' ~ domain.name if app.subdomain else domain.name %}
						{% set app_url = "https://" ~ full_domain %}
						<a href="{{ app_url }}" class="deploy-link" target="_blank" rel="noopener noreferrer"
							title="Mở {{ full_domain }} trên tab mới">
							<span class="text-truncate"
								style="font-family:monospace; max-width:210px; display:inline-block; vertical-align:middle;">
								{{ full_domain }}
							</span>
							<i class="fa fa-external-link-alt ms-1" style="font-size:0.93em;color:#007bff;vertical-align:middle;"></i>
						</a>
					</td>
					{% if current_user.is_authenticated and current_user.is_admin %}
					<td>
						{% if app.env %}
						<button class="btn btn-link btn-copy-env p-0" title="Copy ENV" data-env="{{ app.env|e }}">
							<i class="fa fa-copy icon-copy"></i>
							<i class="fa fa-check icon-check d-none"></i>
						</button>
						{% else %}
						<span class="text-secondary">-</span>
						{% endif %}
					</td>
					{% endif %}
					<td>
						{% if app.status == 'active' %}
						<span class="badge bg-success">Đang chạy</span>
						{% elif app.status == 'pending' %}
						<span class="badge bg-warning text-dark">Đang chờ</span>
						{% elif app.status == 'add_txt' %}
						<span class="badge bg-info text-dark">Đã xác minh</span>
						{% elif app.status == 'deploying' %}
						<span class="badge bg-primary">Đang deploy</span>
						{% elif app.status == 'inactive' %}
						<span class="badge bg-secondary">Đã dừng</span>
						{% elif app.status == 'failed' %}
						<span class="badge bg-danger">Lỗi deploy</span>
						{% elif app.status == 'removing' %}
						<span class="badge bg-dark text-light">Đang xóa</span>
						{% else %}
						<span class="badge bg-secondary">{{ app.status }}</span>
						{% endif %}
					</td>
					<td>{{ app.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
					<td>
						<a href="{{ url_for('deployed_app.detail_app', app_id=app.id) }}" class="btn btn-sm btn-outline-info me-1">
							<i class="fa fa-eye"></i> Xem chi tiết
						</a>
						{% if app.status == 'active' %}
						<button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal"
							data-bs-target="#addTxtModal-{{ app.id }}">
							Thêm TXT
						</button>

						<!-- Modal nhập TXT -->
						<div class="modal fade" id="addTxtModal-{{ app.id }}" tabindex="-1"
							aria-labelledby="addTxtLabel-{{ app.id }}" aria-hidden="true">
							<div class="modal-dialog">
								<form action="{{ url_for('deployed_app.add_dns_txt', app_id=app.id) }}" method="post"
									class="modal-content">
									<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
									<div class="modal-header">
										<h5 class="modal-title" id="addTxtLabel-{{ app.id }}">Thêm bản ghi TXT xác minh</h5>
										<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
									</div>
									<div class="modal-body">
										<div class="mb-2">
											<label for="txtValue-{{ app.id }}" class="form-label">Nội dung TXT <span
													class="text-danger">*</span></label>
											<input type="text" name="txt_value" id="txtValue-{{ app.id }}" class="form-control"
												placeholder="facebook-domain-verification=..." required autofocus>
										</div>
									</div>
									<div class="modal-footer">
										<button type="submit" class="btn btn-primary">Xác nhận</button>
										<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Huỷ</button>
									</div>
								</form>
							</div>
						</div>
						{% elif app.status == 'add_txt' %}
						<form action="{{ url_for('deployed_app.stop_app', app_id=app.id) }}" method="post" class="d-inline">
							<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
							<button type="submit" class="btn btn-sm btn-outline-warning">Dừng App</button>
						</form>
						{% elif app.status == 'failed' %}
						<form action="{{ url_for('deployed_app.redeploy_app', app_id=app.id) }}" method="post" class="d-inline">
							<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
							<button type="submit" class="btn btn-sm btn-outline-danger">Deploy lại</button>
						</form>
						{% else %}
						<span class="text-muted"></span>
						{% endif %}
					</td>
				</tr>
				{% endfor %}
				{% if deployed_apps|length == 0 %}
				<tr>
					<td colspan="{{ 7 if (current_user.is_authenticated and current_user.is_admin) else 6 }}"
						class="text-center text-muted py-4">
						<i class="fa fa-exclamation-circle me-1"></i>
						Chưa có app nào được deploy.
					</td>
				</tr>
				{% endif %}
			</tbody>
		</table>
		<!-- Nơi hiện phân trang -->
	</div>
</div>
<style>
	.table-responsive {
		background: #fff;
		border-radius: 12px;
		padding: 0.7rem;
	}

	.table td,
	.table th {
		vertical-align: middle !important;
		line-height: 1.3 !important;
	}

	.text-truncate {
		overflow: hidden;
		text-overflow: ellipsis;
		white-space: nowrap;
		max-width: 210px;
		display: inline-block;
	}

	.deploy-link {
		color: #007bff;
		text-decoration: none;
		transition: color 0.12s;
	}

	.deploy-link:hover {
		color: #0056b3;
		text-decoration: underline;
	}

	.deploy-link .fa-external-link-alt {
		margin-left: 2px;
	}

	.btn-copy-env {
		color: #444;
		background: none;
		border: none;
		cursor: pointer;
		transition: color 0.12s;
		font-size: 1em;
		position: relative;
	}

	.btn-copy-env .icon-check {
		color: #28a745;
		font-size: 1.08em;
		vertical-align: middle;
	}

	.btn-copy-env .icon-copy {
		vertical-align: middle;
	}

	.btn-copy-env.copied .icon-copy {
		display: none;
	}

	.btn-copy-env.copied .icon-check {
		display: inline;
		animation: fadeInOut 1.2s;
	}

	.btn-copy-env .icon-check.d-none {
		display: none;
	}

	@keyframes fadeInOut {
		0% {
			opacity: 0;
		}

		10% {
			opacity: 1;
		}

		80% {
			opacity: 1;
		}

		100% {
			opacity: 0;
		}
	}

	.btn-copy-env:hover {
		color: #007bff;
	}

	.pagination .page-item.active .page-link {
		background: #007bff;
		color: #fff;
		border-color: #007bff;
	}

	@media (max-width: 576px) {

		.table th,
		.table td {
			font-size: 0.98em;
		}
	}
</style>
<script>
	document.addEventListener("DOMContentLoaded", function () {
		const buttons = document.querySelectorAll(".btn-copy-env");
		buttons.forEach(btn => {
			btn.addEventListener("click", function (e) {
				const env = btn.getAttribute("data-env");
				const iconCopy = btn.querySelector('.icon-copy');
				const iconCheck = btn.querySelector('.icon-check');
				// Copy to clipboard
				if (navigator.clipboard) {
					navigator.clipboard.writeText(env).then(function () {
						btn.title = "Đã copy ENV!";
						btn.classList.add("copied");
						iconCopy.classList.add("d-none");
						iconCheck.classList.remove("d-none");
						setTimeout(function () {
							btn.title = "Copy ENV";
							btn.classList.remove("copied");
							iconCopy.classList.remove("d-none");
							iconCheck.classList.add("d-none");
						}, 1200);
					});
				} else {
					// Fallback cho trình duyệt cũ
					const textarea = document.createElement("textarea");
					textarea.value = env;
					document.body.appendChild(textarea);
					textarea.select();
					try { document.execCommand("copy"); } catch (e) { }
					document.body.removeChild(textarea);
					btn.title = "Đã copy ENV!";
					btn.classList.add("copied");
					iconCopy.classList.add("d-none");
					iconCheck.classList.remove("d-none");
					setTimeout(function () {
						btn.title = "Copy ENV";
						btn.classList.remove("copied");
						iconCopy.classList.remove("d-none");
						iconCheck.classList.add("d-none");
					}, 1200);
				}
				e.preventDefault();
				e.stopPropagation();
			});
		});
	});

	// ==== Phân trang + Tìm kiếm + Filter trạng thái ====
	const rowsPerPage = 10;
	let currentPage = 1;

	function normalize(str) {
		return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
	}

	function filterRows() {
		const search = normalize(document.getElementById('searchInput').value.trim());
		const status = document.getElementById('statusFilter').value;
		const tbody = document.querySelector('.table tbody');
		const rows = Array.from(tbody.querySelectorAll('tr'));
		let visibleRows = [];

		rows.forEach(row => {
			let text = row.innerText;
			let normalized = normalize(text);
			let matchesSearch = !search || normalized.includes(search);
			let matchesStatus = !status || row.innerHTML.includes('badge') && row.innerHTML.includes(status);
			row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
			if (matchesSearch && matchesStatus) visibleRows.push(row);
		});
		return visibleRows;
	}

	function paginateRows(visibleRows) {
		const tbody = document.querySelector('.table tbody');
		let totalPages = Math.ceil(visibleRows.length / rowsPerPage);
		currentPage = Math.min(currentPage, totalPages) || 1;
		visibleRows.forEach((row, idx) => {
			row.style.display = (idx >= (currentPage - 1) * rowsPerPage && idx < currentPage * rowsPerPage) ? '' : 'none';
			// Số thứ tự lại
			let sttCell = row.querySelector('td');
			if (sttCell) sttCell.innerText = ((currentPage - 1) * rowsPerPage + idx % rowsPerPage + 1);
		});
		createPagination(totalPages);
	}

	function createPagination(totalPages) {
		let pagination = document.getElementById('pagination');
		if (!pagination) {
			pagination = document.createElement('nav');
			pagination.className = 'd-flex justify-content-center mt-3';
			pagination.id = 'pagination';
			document.querySelector('.table-responsive').appendChild(pagination);
		}
		let html = '';
		if (totalPages > 1) {
			html += `<ul class="pagination mb-0">`;
			for (let i = 1; i <= totalPages; i++) {
				html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
					<a class="page-link" href="#" data-page="${i}">${i}</a>
				</li>`;
			}
			html += `</ul>`;
		}
		pagination.innerHTML = html;

		Array.from(pagination.querySelectorAll('a.page-link')).forEach(a => {
			a.onclick = function (e) {
				e.preventDefault();
				currentPage = parseInt(this.dataset.page);
				paginateRows(filterRows());
				return false;
			}
		});
	}

	document.addEventListener("DOMContentLoaded", function () {
		const searchInput = document.getElementById('searchInput');
		const statusFilter = document.getElementById('statusFilter');
		searchInput.addEventListener('input', () => paginateRows(filterRows()));
		statusFilter.addEventListener('change', () => { currentPage = 1; paginateRows(filterRows()); });

		// Khởi tạo lần đầu
		paginateRows(filterRows());
	});
</script>
{% endblock %}