{% extends "base.html" %}
{% block title %}Chi tiết App đã Deploy{% endblock %}
{% block content %}
<div class="container py-4">
	<div class="d-flex align-items-center mb-4 gap-3 flex-wrap">
		<h2 class="fw-bold mb-0 text-primary">
			<i class="fa fa-info-circle me-2"></i>Chi tiết App đã Deploy
		</h2>
		<span class="badge fs-6
            {% if app.status == 'active' %} bg-success
            {% elif app.status == 'pending' %} bg-warning text-dark
            {% elif app.status == 'add_txt' %} bg-info text-dark
            {% elif app.status == 'failed' %} bg-danger
            {% else %} bg-secondary
            {% endif %}" style="vertical-align:middle;">
			{% if app.status == 'active' %}Đang chạy
			{% elif app.status == 'pending' %}Đang chờ
			{% elif app.status == 'add_txt' %}Đã xác minh
			{% elif app.status == 'failed' %}Lỗi deploy
			{% else %}{{ app.status }}{% endif %}
		</span>
	</div>

	<div class="card shadow-sm border-0 mb-4">
		<div class="card-body px-4 py-3">
			<div class="row g-3 mb-3">
				<div class="col-md-6">
					<div class="mb-2"><strong>ID:</strong> <span class="text-secondary">{{ app.id }}</span></div>
					<div class="mb-2"><strong>Tên server:</strong> <span class="text-secondary">{{ server.name }}</span></div>
					<div class="mb-2"><strong>Tên miền:</strong> <span class="text-secondary">{{ domain.name }}</span></div>
					<div class="mb-2"><strong>Subdomain:</strong> <span class="text-secondary">{{ app.subdomain or '-' }}</span>
					</div>
					<div class="mb-2"><strong>Ghi chú:</strong> <span class="text-secondary">{{ app.note or '-' }}</span></div>
					<div class="mb-2"><strong>Ngày tạo:</strong> <span
							class="text-secondary">{{ app.created_at.strftime('%d/%m/%Y %H:%M') }}</span></div>
				</div>
				<div class="col-md-6">
					<div class="mb-2"><strong>ENV:</strong>
						<pre class="bg-light p-2 rounded border" style="font-size:0.97em; min-height:64px;">{{ app.env or '-' }}
						</pre>
					</div>
					<div class="mb-2"><strong>Log:</strong>
						<pre class="bg-light p-2 rounded border" style="font-size:0.97em; min-height:64px;">{{ app.log or '-' }}
						</pre>
					</div>

					{# Tạo biến động #}
					{% set full_domain = 'https://' ~ ((app.subdomain ~ '.' if app.subdomain else '') ~ domain.name) %}
					{% set policy_url = full_domain ~ '/polices' %}


					<!-- BLOCK THÔNG TIN MỚI: ĐÃ TỐI ƯU GIAO DIỆN -->
					<div class="info-block-list mt-4">
						<div class="info-row">
							<span class="info-label">Tên miền:</span>
							<span class="info-value" id="domainText-{{ app.id }}">{{ full_domain }}</span>
							<button type="button" class="btn btn-sm btn-light btn-copy"
								onclick="copyToClipboard('domainText-{{ app.id }}', this)">
								<i class="fa fa-copy"></i>
							</button>
						</div>
						<div class="info-row">
							<span class="info-label">URL chính sách quyền riêng tư:</span>
							<span class="info-value" id="policyUrlText-{{ app.id }}">{{ policy_url }}</span>
							<button type="button" class="btn btn-sm btn-light btn-copy"
								onclick="copyToClipboard('policyUrlText-{{ app.id }}', this)">
								<i class="fa fa-copy"></i>
							</button>
						</div>
						<div class="info-row">
							<span class="info-label">Quyền:</span>
							<span class="info-value" id="quyen-{{ app.id }}">publish_video</span>
							<button type="button" class="btn btn-sm btn-light btn-copy"
								onclick="copyToClipboard('quyen-{{ app.id }}', this)">
								<i class="fa fa-copy"></i>
							</button>
						</div>
						<div class="info-row align-items-start">
							<span class="info-label pt-1">Mô tả sử dụng Dữ liệu nền tảng:</span>
							<span class="info-value" style="max-width: 420px;" id="descText-{{ app.id }}">
								Doanh nghiệp chúng tôi sử dụng Dữ liệu trên nền tảng để giúp khách hàng quản lý quảng cáo và các bài
								đăng trên các
								kênh mạng xã hội hoặc trang web. Khách hàng cung cấp thông tin về các chiến dịch quảng cáo, bài đăng
								hoặc yêu cầu
								quảng cáo riêng. Chúng tôi dùng dữ liệu này để tạo, quản lý và theo dõi các chiến dịch quảng cáo theo ý
								muốn của
								khách hàng. Khách hàng sẽ sử dụng dịch vụ để xem, chỉnh sửa, theo dõi hiệu quả các chiến dịch và bài
								đăng của mình
								một cách dễ dàng và thuận tiện. Chúng tôi chỉ sử dụng Dữ liệu trên nền tảng để phục vụ cho việc quản lý
								quảng cáo
								cho khách hàng và không dùng cho mục đích khác.
							</span>
							<button type="button" class="btn btn-sm btn-light btn-copy mt-1"
								onclick="copyToClipboard('descText-{{ app.id }}', this)">
								<i class="fa fa-copy"></i>
							</button>
						</div>
					</div>
					<!-- KẾT THÚC BLOCK TỐI ƯU -->

					{% if verification %}
					<div class="mb-2">
						<strong>TXT xác minh hiện tại:</strong>
						<code class="d-block mt-1 mb-1" style="font-size:1em">{{ verification.txt_value }}</code>
						<span class="small text-muted">Số lần tạo/cập nhật: {{ verification.create_count }}</span>
					</div>
					{% endif %}
					<form action="{{ url_for('deployed_app.add_dns_txt', app_id=app.id) }}" method="post" class="mt-2 mb-2">
						<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
						<div class="input-group">
							<input type="text" class="form-control" name="txt_value" placeholder="Nhập TXT xác minh mới..."
								value="{{ verification.txt_value if verification else '' }}" required>
							<button type="submit" class="btn btn-outline-primary">
								<i class="fa fa-sync-alt me-1"></i>Cập nhật TXT
							</button>
						</div>
						<small class="form-text text-muted">Bạn có thể cập nhật giá trị TXT mới cho app này bất cứ lúc nào.</small>
					</form>
				</div>
			</div>
		</div>
	</div>
	<a href="{{ url_for('deployed_app.list_app') }}" class="btn btn-outline-secondary">
		<i class="fa fa-arrow-left me-1"></i>Quay lại danh sách
	</a>
</div>

<style>
	.card-body strong {
		min-width: 110px;
		display: inline-block;
	}

	pre {
		margin-bottom: 0;
		overflow-x: auto;
		word-break: break-all;
	}

	code {
		background: #eef6fa;
		padding: 2px 8px;
		border-radius: 4px;
	}

	/* Tối ưu cho block mới */
	.info-block-list {
		margin-top: 1.2em;
	}

	.info-row {
		display: flex;
		align-items: center;
		gap: 10px;
		margin-bottom: 0.8em;
		flex-wrap: wrap;
		word-break: break-all;
	}

	.info-label {
		min-width: 180px;
		font-weight: 600;
		color: #37517e;
	}

	.info-value {
		font-family: 'Fira Mono', monospace, 'Consolas', 'Menlo', 'monospace';
		color: #212529;
		background: #f8fafc;
		border-radius: 5px;
		padding: 3px 10px;
		margin-right: 6px;
		font-size: 1.05em;
		max-width: 100%;
	}

	.btn-copy {
		padding: 2px 8px 2px 7px;
		font-size: 1em;
		border: 1px solid #e4e4e4;
		box-shadow: none;
		transition: background 0.18s;
	}

	.btn-copy:active,
	.btn-copy:focus {
		background: #eef6fa !important;
		outline: none;
	}

	@media (max-width: 900px) {
		.info-row {
			flex-direction: column;
			align-items: flex-start;
			gap: 4px;
		}

		.info-label,
		.info-value {
			font-size: 1em;
			min-width: 0;
		}
	}

	@media (max-width: 768px) {
		.card-body .row>div {
			margin-bottom: 1rem;
		}
	}
</style>
<!-- Script copy cho nút -->
<script>
	function copyToClipboard(elementId, btn) {
		var el = document.getElementById(elementId);
		var text = el ? el.innerText : '';
		navigator.clipboard.writeText(text).then(function () {
			btn.classList.remove('btn-light');
			btn.classList.add('btn-success');
			btn.innerHTML = '<i class="fa fa-check"></i>';
			setTimeout(function () {
				btn.classList.add('btn-light');
				btn.classList.remove('btn-success');
				btn.innerHTML = '<i class="fa fa-copy"></i>';
			}, 1200);
		});
	}
</script>
{% endblock %}