{% extends "base.html" %}
{% block title %}Deploy App{% endblock %}

{% block content %}
<div class="container py-4">
	<h2 class="mb-4"><i class="fa fa-plus text-primary me-2"></i>Deploy App Mới</h2>
	<form method="POST" id="deployAppForm" novalidate autocomplete="off">
		{{ form.hidden_tag() }}
		<div class="row g-3 mb-3">
			<div class="col-md-6">
				{{ form.server_id.label(class="form-label") }}
				{{ form.server_id(class="form-select") }}
			</div>
			<div class="col-md-6">
				{{ form.domain_id.label(class="form-label") }}
				{{ form.domain_id(class="form-select") }}
			</div>
			<div class="col-md-6">
				{{ form.subdomain.label(class="form-label") }}<span class="text-danger ms-1">*</span>
				{{ form.subdomain(class="form-control", required=True, placeholder="Nhập subdomain (không nhập @)") }}
				<small class="form-text text-muted">Subdomain là bắt buộc, không nhập @ hoặc để trống.</small>
				<div class="invalid-feedback" id="subdomainError"></div>
			</div>
			<div class="col-md-6">
				{{ form.note.label(class="form-label") }}
				{{ form.note(class="form-control", placeholder="Ghi chú (tuỳ chọn)") }}
			</div>
		</div>

		<div class="card shadow-sm border mb-4">
			<div class="card-body">
				<h5 class="mb-3"><i class="fa fa-cogs me-2"></i>Cấu hình ENV cho App</h5>
				<div class="row g-3">
					<div class="col-md-4">
						{{ form.APP_ID.label(class="form-label") }}
						{{ form.APP_ID(class="form-control", placeholder="VD: 1446880516636968") }}
					</div>
					<div class="col-md-4">
						{{ form.APP_SECRET.label(class="form-label") }}
						{{ form.APP_SECRET(class="form-control", placeholder="Mã bí mật ứng dụng Facebook") }}
					</div>
					<div class="col-md-4">
						{{ form.APP_NAME.label(class="form-label") }}
						{{ form.APP_NAME(class="form-control", placeholder="VD: Manage Campaign") }}
					</div>
		
					<div class="col-md-4">
						{{ form.EMAIL.label(class="form-label") }}
						{{ form.EMAIL(class="form-control", placeholder="VD: example@gmail.com") }}
					</div>
					<div class="col-md-4">
						{{ form.ADDRESS.label(class="form-label") }}
						{{ form.ADDRESS(class="form-control", placeholder="VD: 147 Thái Phiên, Quận 11, TP.HCM") }}
					</div>
					<div class="col-md-4"></div> <!-- div trống để cân bằng hàng -->
		
					<div class="col-md-4">
						{{ form.PHONE_NUMBER.label(class="form-label") }}
						{{ form.PHONE_NUMBER(class="form-control", placeholder="VD: 07084773586") }}
					</div>
					<div class="col-md-4">
						{{ form.COMPANY_NAME.label(class="form-label") }}
						{{ form.COMPANY_NAME(class="form-control", placeholder="VD: CÔNG TY TNHH NOIR STEED") }}
					</div>
					<div class="col-md-4">
						{{ form.TAX_NUMBER.label(class="form-label") }}
						{{ form.TAX_NUMBER(class="form-control", placeholder="VD: 0318728792") }}
					</div>
				</div>
			</div>
		</div>


		<div class="d-flex gap-2 mt-3">
			<button type="submit" class="btn btn-success px-4">
				<i class="fa fa-paper-plane me-2"></i>Deploy App
			</button>
			<button id="btnDefaultEnv" type="button" class="btn btn-outline-secondary">
				<i class="fa fa-magic me-1"></i>Đề giá trị mặc định
			</button>
		</div>
	</form>
</div>

<script>
	function slugify(text) {
		return text
			.normalize("NFD")                // tách dấu tiếng Việt
			.replace(/[\u0300-\u036f]/g, "") // xóa dấu
			.toLowerCase()
			.replace(/[^a-z0-9]+/g, "-")     // thay ký tự đặc biệt bằng -
			.replace(/^-+|-+$/g, "");        // bỏ - đầu/cuối
	}

	document.querySelector('input[name="APP_NAME"]').addEventListener('input', function () {
		const appName = this.value.trim();
		if (appName.length === 0) return;

		// Tạo subdomain
		const sub = slugify(appName);

		// Tạo email (domain mặc định, có thể đổi)
		const email = sub + "@info.com";

		// Company name
		const company = "CÔNG TY TNHH " + appName.toUpperCase();

		// --- Điền giá trị vào form ---
		document.querySelector('input[name="subdomain"]').value = sub;
		document.querySelector('input[name="EMAIL"]').value = email;
		document.querySelector('input[name="COMPANY_NAME"]').value = company;

		// Các trường khác có thể để mặc định
		document.querySelector('input[name="ADDRESS"]').value = "147 Thái Phiên, Phường 9, Quận 11, TP.HCM, Việt Nam";
		document.querySelector('input[name="PHONE_NUMBER"]').value = "07084773586";
		document.querySelector('input[name="TAX_NUMBER"]').value = "0318728792";
	});
</script>

<style>
	.card-body {
		background: #f8fafc;
	}

	.form-label {
		font-weight: 500;
	}

	.form-control,
	.form-select {
		border-radius: 0.35rem;
	}

	.btn-success {
		min-width: 140px;
	}

	.btn-outline-secondary {
		min-width: 170px;
	}
</style>
{% endblock %}