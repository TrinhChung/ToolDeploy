{% extends "base.html" %}
{% block title %}Danh sách Website đã tạo{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
    <h2 style="margin: 0;">Danh sách Website đã tạo</h2>
    <a href="{{ url_for('genweb.create_website') }}" style="
      padding: 8px 16px; background: #007bff; color: white; border-radius: 6px;
      text-decoration: none; font-weight: 600; transition: background 0.2s;">
        + Tạo website mới
    </a>
</div>

<!-- Thanh tìm kiếm -->
<div style="margin-bottom: 14px;">
    <input id="searchInput" class="form-control" style="max-width: 300px;" type="text"
        placeholder="Tìm kiếm tên công ty, link, server..." autocomplete="off">
</div>

<table id="websiteTable" style="
    width: 100%; border-collapse: collapse; border-radius: 10px; overflow: hidden;
    box-shadow: 0 2px 8px #0001;">
    <thead>
        <tr style="background: #f2f2f2;">
            <th style="padding: 10px; border-bottom: 2px solid #eee; width: 48px;">STT</th>
            <th style="padding: 10px; border-bottom: 2px solid #eee;">Công ty</th>
            <th style="padding: 10px; border-bottom: 2px solid #eee;">Link tĩnh</th>
            <th style="padding: 10px; border-bottom: 2px solid #eee;">Server</th>
            <th style="padding: 10px; border-bottom: 2px solid #eee;">Thao tác</th>
        </tr>
    </thead>
    <tbody>
        {% for website_id, company_name, static_page_link, server_name, server_ip in websites %}
        <tr style="transition: background 0.2s;" onmouseover="this.style.background='#f8fafc'"
            onmouseout="this.style.background='white'">
            <td style="padding: 10px; text-align: center; color: #888; font-weight: 600;">
                {{ loop.index }}
            </td>
            <td style="padding: 10px;">{{ company_name }}</td>
            <td style="padding: 10px;">
                {% if static_page_link %}
                <a href="http://{{ static_page_link }}" target="_blank"
                    style="color: #007bff; text-decoration: underline;">
                    {{ static_page_link }}
                </a>
                {% else %}
                <span style="color: #888;">-</span>
                {% endif %}
            </td>
            <td style="padding: 10px;">
                {{ server_name }}
            </td>
            <td style="padding: 10px;">
                <a href="{{ url_for('genweb.view_website', website_id=website_id) }}"
                    class="btn btn-sm btn-outline-primary">
                    Xem chi tiết
                </a>
                <form action="{{ url_for('genweb.delete_website', website_id=website_id) }}" method="post"
                    style="display:inline" onsubmit="return confirm('Bạn chắc chắn muốn xóa website này?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-sm btn-outline-danger">Xóa</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<!-- Nơi hiện phân trang -->
<div id="pagination"></div>

<script>
    const rowsPerPage = 30;
    let currentPage = 1;

    function normalize(str) {
        return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }

    function filterRows() {
        const search = normalize(document.getElementById('searchInput').value.trim());
        const table = document.getElementById('websiteTable');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        let visibleRows = [];

        rows.forEach(row => {
            let text = row.innerText;
            let normalized = normalize(text);
            let matchesSearch = !search || normalized.includes(search);
            row.style.display = matchesSearch ? '' : 'none';
            if (matchesSearch) visibleRows.push(row);
        });
        return visibleRows;
    }

    function paginateRows(visibleRows) {
        let totalPages = Math.ceil(visibleRows.length / rowsPerPage);
        currentPage = Math.min(currentPage, totalPages) || 1;
        visibleRows.forEach((row, idx) => {
            row.style.display = (idx >= (currentPage - 1) * rowsPerPage && idx < currentPage * rowsPerPage) ? '' : 'none';
            // Số thứ tự lại
            let sttCell = row.querySelector('td');
            if (sttCell) sttCell.innerText = ((currentPage - 1) * rowsPerPage + idx % rowsPerPage + 1);
        });
        createPagination(totalPages);
    }

    function createPagination(totalPages) {
        let pagination = document.getElementById('pagination');
        let html = '';
        if (totalPages > 1) {
            html += `<ul class="pagination mb-0" style="justify-content:center;">`;
            for (let i = 1; i <= totalPages; i++) {
                html += `<li class="page-item${i === currentPage ? ' active' : ''}">
                <a class="page-link" href="#" data-page="${i}">${i}</a>
            </li>`;
            }
            html += `</ul>`;
        }
        pagination.innerHTML = html;

        Array.from(pagination.querySelectorAll('a.page-link')).forEach(a => {
            a.onclick = function (e) {
                e.preventDefault();
                currentPage = parseInt(this.dataset.page);
                paginateRows(filterRows());
                return false;
            }
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', () => paginateRows(filterRows()));
        paginateRows(filterRows());
    });
</script>
{% endblock %}