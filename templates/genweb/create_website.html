{% extends "base.html" %}
{% block content %}
<div class="container py-4">
    <h3 class="mb-3"><i class="fa fa-plus"></i> Tạo website mới</h3>
    <form method="post" id="companyForm" novalidate>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="toggleRawInput">
            <label class="form-check-label" for="toggleRawInput">
                Nhập thông tin khách hàng dạng text
            </label>
        </div>
        <div id="rawInputArea" style="display: none;">
            <label class="form-label">Dán thông tin khách hàng</label>
            <textarea class="form-control mb-2" id="rawInput" rows="5"
                placeholder="Dán đoạn text như khách gửi vào đây..."></textarea>
            <button type="button" class="btn btn-sm btn-secondary" onclick="normalizeCustomerText()">Chuẩn hóa & điền
                vào form</button>
            <div id="normalizeError" class="text-danger mt-2"></div>
            <hr>
        </div>
        <h5 class="mb-3 mt-4">Thông tin công ty</h5>
        <div class="mb-3">
            <label class="form-label">Tên công ty</label>
            <input name="company_name" required class="form-control">
        </div>
        <div class="mb-3">
            <label class="form-label">Địa chỉ</label>
            <input name="address" required class="form-control">
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Hotline</label>
                <input name="hotline" required class="form-control">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Email (auto)</label>
                <input name="email" type="email" required class="form-control">
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Subdomain (auto)</label>
                <input name="subdomain" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Mã số thuế</label>
                <input name="license_no" class="form-control">
            </div>
        </div>
        <div class="row">
            <div class="mb-3">
                <label class="form-label">Google Map Embed</label>
                <input name="google_map_embed" class="form-control" id="mapEmbedInput"
                    placeholder="Nhập địa chỉ hoặc dán link Google Maps">
                <div class="form-text">
                    <b>Gợi ý:</b> Bạn có thể nhập địa chỉ hoặc dán link Google Maps.<br>
                    <b>Cách lấy link nhúng chính xác:</b>
                    <ol style="margin: 0 0 0 22px;padding:0">
                        <li>Mở địa chỉ trên <a href="https://maps.google.com/" target="_blank">Google Maps</a></li>
                        <li>Bấm “Chia sẻ” &rarr; chọn tab “Nhúng bản đồ”</li>
                        <li>Copy phần <b>src="..."</b> và dán vào ô này</li>
                    </ol>
                    <i>Nếu chỉ nhập địa chỉ, hệ thống sẽ tạo link embed đơn giản (có thể không tối ưu bằng link chính
                        xác Google cung cấp).</i>
                </div>
                <div id="mapSuggest" class="mt-2"></div>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Footer Text</label>
                <input name="footer_text" class="form-control">
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">Mô tả ngắn</label>
            <input name="description" class="form-control">
        </div>
        <div class="mb-3">
            <label class="form-label">Ghi chú</label>
            <textarea name="company_note" class="form-control" rows="2"></textarea>
        </div>
        <hr class="my-4">
        <h5 class="mb-3 mt-4">Thông tin website</h5>
        <<div class="mb-3">
            <label class="form-label">Server</label>
            <select name="server_id" required class="form-select">
                {% if servers %}
                {% for s in servers %}
                <option value="{{ s.id }}" {% if loop.first %}selected{% endif %}>
                    {{ s.name }} ({{ s.ip }})
                </option>
                {% endfor %}
                {% else %}
                <option value="">-- Không có server --</option>
                {% endif %}
            </select>
</div>

<div class="mb-3">
    <label class="form-label">Domain</label>
    <select name="domain_id" required class="form-select" id="domainSelect">
        {% if dns_records %}
        {% for d in dns_records %}
        <option value="{{ d.id }}" {% if loop.first %}selected{% endif %}>
            {{ d.name }}
        </option>
        {% endfor %}
        {% else %}
        <option value="">-- Không có domain --</option>
        {% endif %}
    </select>
</div>

<div class="mb-3">
    <label class="form-label">Template</label>
    <select name="template_id" required class="form-select">
        {% if templates %}
        {% for t in templates %}
        <option value="{{ t.id }}" {% if loop.first %}selected{% endif %}>
            {{ t.name }}
        </option>
        {% endfor %}
        {% else %}
        <option value="">-- Không có template --</option>
        {% endif %}
    </select>
</div>

<div class="mb-3">
    <label class="form-label">Link tĩnh</label>
    <input name="static_page_link" class="form-control" id="staticPageLink" readonly>
</div>
<div class="mb-3">
    <label class="form-label">Ghi chú website</label>
    <textarea name="website_note" class="form-control" rows="2"></textarea>
</div>
<div class="d-flex gap-2">
    <button type="submit" class="btn btn-primary"><i class="fa fa-save"></i> Tạo website</button>
    <a href="{{ url_for('genweb.list_website') }}" class="btn btn-outline-secondary">Huỷ</a>
</div>
</form>
</div>

<script>
    // Remove Vietnamese tones
    function removeVietnameseTones(str) {
        return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/đ/g, 'd').replace(/Đ/g, 'D');
    }

    // Clean and get string for email/subdomain (bỏ stopword, không dấu, không space)
    function cleanForEmailAndSubdomain(name) {
        const stopwords = ["llc", "jsc", "co", "ltd", "inc", "company", "corp", "corporation", "plc", "limited", "joint", "stock"];
        let tokens = name.split(' ').filter(word => !stopwords.includes(word.toLowerCase()));
        let cleaned = removeVietnameseTones(tokens.join(' '));
        return cleaned;
    }

    function makeEmail(companyName) {
        let s = cleanForEmailAndSubdomain(companyName);
        s = s.replace(/[^\w\s]/g, '');
        s = s.replace(/\s+/g, '').toLowerCase();
        return s ? (s + '@gmail.com') : '';
    }

    function makeSubdomain(companyName) {
        let s = cleanForEmailAndSubdomain(companyName);
        s = s.replace(/[^\w\s-]/g, '');
        s = s.replace(/\s+/g, '').toLowerCase();
        s = s.replace(/-+/g, '').replace(/^-|-$/g, '');
        return s;
    }

    // Lấy text domain đã chọn (không phải value id)
    function getSelectedDomainText() {
        const domainSelect = document.getElementById('domainSelect');
        if (!domainSelect) return '';
        const opt = domainSelect.options[domainSelect.selectedIndex];
        return opt && opt.value ? opt.text : '';
    }

    // Cập nhật link tĩnh khi đổi subdomain/domain
    function updateStaticPageLink() {
        let sub = document.querySelector('input[name="subdomain"]').value.trim();
        let domainText = getSelectedDomainText();
        document.getElementById('staticPageLink').value = (sub && domainText) ? `${sub}.${domainText}` : '';
    }

    // Gán sự kiện onchange cho input và select
    document.addEventListener('DOMContentLoaded', function () {
            document.querySelector('input[name="subdomain"]').addEventListener('input', updateStaticPageLink);
            document.getElementById('domainSelect').addEventListener('change', updateStaticPageLink);
            // --- GỌI NGAY LÚC LOAD TRANG ---
            updateStaticPageLink();
        });

    document.getElementById('toggleRawInput').addEventListener('change', function () {
        document.getElementById('rawInputArea').style.display = this.checked ? 'block' : 'none';
    });

    function normalizeCustomerText() {
        const text = document.getElementById('rawInput').value;
        const errorDiv = document.getElementById('normalizeError');
        errorDiv.innerText = "";

        if (!text.trim()) {
            errorDiv.innerText = "Vui lòng nhập thông tin khách hàng dạng text!";
            return;
        }

        const stopwords = ["llc", "jsc", "co", "ltd", "inc", "company", "corp", "corporation", "plc", "limited", "joint", "stock"];
        let lines = text.split('\n').map(l => l.trim()).filter(Boolean);

        let company_name = '';
        let address = '';
        let hotline = '';
        let license_no = '';
        let description = '';
        let email = '';
        let subdomain = '';

        let full_text = lines.join('\n');

        // 1. Company name = dòng đầu tiên (bỏ stopwords cuối nếu có)
        if (lines.length) {
            let tokens = lines[0].split(' ');
            while (tokens.length && stopwords.includes(tokens[tokens.length - 1].toLowerCase().replace(/[\W_]+/g, ''))) {
                tokens.pop();
            }
            company_name = tokens.join(' ').trim();
        }

        // 2. Lấy số điện thoại: dòng nào có 8-20 chữ số (USA/EU)
        for (let l of lines) {
            let phone = l.replace(/\D/g, '');
            if (phone.length >= 8 && phone.length <= 20) {
                hotline = l.match(/[\d\-\+\(\)\s]+/g)?.join('').trim() || '';
                break;
            }
        }

        // 3. License/MST
        let lic = full_text.match(/(License|Organization)[^\d]*[:：]?\s*([\w\-]+)/i);
        license_no = lic ? lic[2] : '';

        // 4. Địa chỉ = dòng bắt đầu từ "Full Address" hoặc chứa số, không phải số điện thoại
        let addrFound = false;
        for (let i = 0; i < lines.length; i++) {
            let l = lines[i];
            if (/Full Address/i.test(l)) {
                let j = i + 1;
                let addrArr = [];
                while (j < lines.length && !/\d{8,}/.test(lines[j])) {
                    addrArr.push(lines[j]);
                    j++;
                }
                address = addrArr.join(', ');
                addrFound = true;
                break;
            }
        }
        if (!addrFound) {
            for (let l of lines.slice(1)) {
                if (/[a-zA-Z]/.test(l) && !/\d{8,}/.test(l)) {
                    address = l;
                    break;
                }
            }
        }
        // 5. Email (nếu có)
        let emailMatch = full_text.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/);
        email = emailMatch ? emailMatch[0] : '';

        // 6. Description/auto fields
        let autoDesc = company_name
            ? `${company_name} is a company operating in the fashion industry, providing high-quality products and reliable services to customers.`
            : '';
        let autoFooter = company_name
            ? `© ${company_name} - Your trusted fashion brand.`
            : '';

        // Nếu trong text có footer thì lấy, không thì dùng auto
        let footerText = '';
        let footerMatch = full_text.match(/footer[:：]?\s*(.*)/i);
        if (footerMatch && footerMatch[1]) {
            footerText = footerMatch[1].trim();
        }

        // Auto email và subdomain
        let autoEmail = makeEmail(company_name);
        let autoSubdomain = makeSubdomain(company_name);

        document.querySelector('input[name="company_name"]').value = company_name;
        document.querySelector('input[name="address"]').value = address;
        document.querySelector('input[name="hotline"]').value = hotline;
        document.querySelector('input[name="license_no"]').value = license_no;
        document.querySelector('input[name="description"]').value = autoDesc;
        document.querySelector('input[name="email"]').value = email || autoEmail;
        document.querySelector('input[name="subdomain"]').value = autoSubdomain;
        document.querySelector('input[name="footer_text"]').value = footerText || autoFooter;

        // Link tĩnh auto (sau khi điền subdomain + domain)
        let domainText = getSelectedDomainText();
        let staticPageLink = (autoSubdomain && domainText) ? `${autoSubdomain}.${domainText}` : '';
        document.getElementById('staticPageLink').value = staticPageLink;
    }

    // Validate các trường bắt buộc trước khi submit
    document.getElementById('companyForm').addEventListener('submit', function (e) {
        const requiredFields = [
            'company_name',
            'address',
            'hotline',
            'email',
            'subdomain',
            'license_no',
            'google_map_embed',
            'footer_text',
            'description',
            'server_id',
            'dns_record_id',
            'template_id',
            'static_page_link'
        ];
        let firstError = null;
        for (const name of requiredFields) {
            const field = document.querySelector(`[name="${name}"]`);
            if (field && !field.value.trim()) {
                if (!firstError) firstError = field;
                field.classList.add('is-invalid');
            } else if (field) {
                field.classList.remove('is-invalid');
            }
        }
        if (firstError) {
            e.preventDefault();
            firstError.focus();
            alert("Vui lòng nhập đầy đủ thông tin vào tất cả các trường bắt buộc!");
        }
    });

    // Spinner HTML
    const spinnerHtml = `<div style="text-align:center;padding:10px"><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang tải bản đồ...</div>`;

    // Tạo link embed map từ địa chỉ
    function makeGoogleMapEmbedUrl(address) {
        if (!address || address.trim().length === 0) return "";
        return `https://www.google.com/maps?q=${encodeURIComponent(address)}&output=embed`;
    }

    // Render Google Map preview khi địa chỉ thay đổi
    function updateGoogleMapEmbed() {
        const addressInput = document.querySelector('input[name="address"]');
        const embedInput = document.querySelector('input[name="google_map_embed"]');
        const mapPreview = document.getElementById('mapEmbedPreview');
        if (!addressInput || !embedInput || !mapPreview) return;
        const address = addressInput.value.trim();
        if (!address) {
            embedInput.value = "";
            mapPreview.innerHTML = "";
            return;
        }
        // Spinner khi đang loading
        mapPreview.innerHTML = spinnerHtml;
        // Tạo link
        const embedUrl = makeGoogleMapEmbedUrl(address);
        // Gán vào ô input Google Map Embed
        embedInput.value = embedUrl;
        // Tạo iframe preview
        setTimeout(() => {
            mapPreview.innerHTML = `<iframe src="${embedUrl}" width="100%" height="300" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>`;
        }, 300);
    }

    // Gán sự kiện onchange cho trường địa chỉ
    document.addEventListener('DOMContentLoaded', function () {
        // Thêm khung preview map dưới ô nhập google_map_embed
        const mapEmbedRow = document.querySelector('input[name="google_map_embed"]').closest('.mb-3');
        if (mapEmbedRow) {
            const mapPreviewDiv = document.createElement('div');
            mapPreviewDiv.id = "mapEmbedPreview";
            mapPreviewDiv.className = "mt-2";
            mapEmbedRow.appendChild(mapPreviewDiv);
        }
        // Update mỗi khi thay đổi địa chỉ
        document.querySelector('input[name="address"]').addEventListener('input', updateGoogleMapEmbed);
        // Khi điền auto từ normalize cũng gọi lại
        const oldNormalize = window.normalizeCustomerText;
        window.normalizeCustomerText = function () {
            oldNormalize();
            updateGoogleMapEmbed();
        };
    });
</script>
<style>
    .is-invalid {
        border: 1.5px solid #dc3545 !important;
        background: #fff6f7;
    }

    .spinner-border {
        display: inline-block;
        width: 1.5rem;
        height: 1.5rem;
        vertical-align: text-bottom;
        border: 0.2em solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        animation: spinner-border .75s linear infinite;
    }

    @keyframes spinner-border {
        100% {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}